# 技术架构流程图

本文档通过流程图的方式展示系统的技术架构，帮助开发团队更清晰地理解系统设计。

---

## 1. 整体系统架构图

```mermaid
graph TB
    subgraph "用户层"
        User[用户]
    end
    
    subgraph "前端应用层 (React + Vite + TypeScript)"
        UI[UI组件层<br/>React Components]
        Business[业务逻辑层<br/>Services & Hooks]
        State[状态管理层<br/>Zustand Stores]
        DataAccess[数据访问层<br/>Repositories]
    end
    
    subgraph "本地存储层"
        IDB[(IndexedDB<br/>Dexie.js)]
        LocalCache[本地缓存]
    end
    
    subgraph "后端服务层 (可选)"
        API[API服务<br/>Express/FastAPI]
        Auth[认证服务<br/>JWT]
        Sync[同步服务]
    end
    
    subgraph "云端存储"
        CloudDB[(PostgreSQL<br/>MongoDB)]
    end
    
    subgraph "外部服务"
        VoiceAPI[语音识别API<br/>Web Speech API/第三方]
        AIAPI[AI分析服务<br/>GPT-4/Claude/大模型]
    end
    
    User --> UI
    UI --> Business
    Business --> State
    Business --> DataAccess
    DataAccess --> IDB
    DataAccess --> LocalCache
    DataAccess -.异步同步.-> API
    API --> Auth
    API --> Sync
    Sync --> CloudDB
    Business --> VoiceAPI
    Business --> AIAPI
    
    style User fill:#e1f5ff
    style UI fill:#fff4e6
    style Business fill:#f3e5f5
    style State fill:#e8f5e9
    style DataAccess fill:#fff9c4
    style IDB fill:#c8e6c9
    style API fill:#ffccbc
    style CloudDB fill:#b3e5fc
    style VoiceAPI fill:#f8bbd0
    style AIAPI fill:#f8bbd0
```

---

## 2. 数据流架构图

```mermaid
sequenceDiagram
    participant User as 用户
    participant UI as UI组件
    participant Service as 业务服务层
    participant Store as 状态管理
    participant Repo as 数据仓库
    participant IDB as IndexedDB
    participant API as 后端API
    participant CloudDB as 云端数据库
    
    Note over User,CloudDB: 写入流程（本地优先）
    User->>UI: 创建/更新任务
    UI->>Service: 调用业务方法
    Service->>Store: 更新状态
    Service->>Repo: 保存数据
    Repo->>IDB: 立即写入本地
    IDB-->>Repo: 写入成功
    Repo-->>Service: 返回结果
    Service-->>UI: 更新UI
    UI-->>User: 操作完成
    
    Note over IDB,CloudDB: 后台同步（异步）
    IDB->>API: 检测到待同步数据
    API->>CloudDB: 保存到云端
    CloudDB-->>API: 同步成功
    API-->>IDB: 更新同步状态
    
    Note over User,CloudDB: 读取流程（本地优先）
    User->>UI: 查看任务列表
    UI->>Service: 请求数据
    Service->>Repo: 查询数据
    Repo->>IDB: 从本地读取
    IDB-->>Repo: 返回数据
    alt 本地数据过期或不存在
        Repo->>API: 请求云端数据
        API->>CloudDB: 查询数据
        CloudDB-->>API: 返回数据
        API-->>Repo: 返回数据
        Repo->>IDB: 更新本地缓存
    end
    Repo-->>Service: 返回数据
    Service-->>UI: 更新UI
    UI-->>User: 显示数据
```

---

## 3. 前端架构分层图

```mermaid
graph TD
    subgraph "表现层 (Presentation Layer)"
        A1[页面组件<br/>Pages]
        A2[业务组件<br/>Business Components]
        A3[基础组件<br/>Common Components]
    end
    
    subgraph "状态管理层 (State Layer)"
        B1[TaskStore<br/>任务状态]
        B2[JournalStore<br/>日记状态]
        B3[SettingsStore<br/>设置状态]
        B4[UIStore<br/>UI状态]
    end
    
    subgraph "业务逻辑层 (Business Layer)"
        C1[TaskService<br/>任务服务]
        C2[JournalService<br/>日记服务]
        C3[SyncService<br/>同步服务]
        C4[AIService<br/>AI服务]
    end
    
    subgraph "数据访问层 (Data Access Layer)"
        D1[TaskRepository<br/>任务仓库]
        D2[JournalRepository<br/>日记仓库]
        D3[Database<br/>Dexie实例]
    end
    
    subgraph "工具层 (Utils Layer)"
        E1[DateUtils<br/>日期工具]
        E2[RecurrenceUtils<br/>重复规则工具]
        E3[EncryptionUtils<br/>加密工具]
    end
    
    A1 --> A2
    A2 --> A3
    A1 --> B1
    A1 --> B2
    A2 --> C1
    A2 --> C2
    C1 --> D1
    C2 --> D2
    D1 --> D3
    D2 --> D3
    C1 --> E1
    C1 --> E2
    C3 --> E3
    C4 --> D1
    C4 --> D2
    C4 --> D3
    
    style A1 fill:#e3f2fd
    style A2 fill:#e3f2fd
    style A3 fill:#e3f2fd
    style B1 fill:#f3e5f5
    style B2 fill:#f3e5f5
    style B3 fill:#f3e5f5
    style B4 fill:#f3e5f5
    style B5 fill:#f3e5f5
    style C1 fill:#e8f5e9
    style C2 fill:#e8f5e9
    style C3 fill:#e8f5e9
    style C4 fill:#e8f5e9
    style C5 fill:#e8f5e9
    style D1 fill:#fff9c4
    style D2 fill:#fff9c4
    style D3 fill:#fff9c4
    style D4 fill:#fff9c4
    style E1 fill:#fce4ec
    style E2 fill:#fce4ec
    style E3 fill:#fce4ec
```

---

## 4. 数据存储架构图

```mermaid
erDiagram
    USERS ||--o{ TASKS : "创建"
    USERS ||--o{ JOURNALS : "创建"
    TASKS ||--o{ TASKS : "关联"
    TASKS }o--o{ TAGS : "标记"
    JOURNALS }o--o{ TASKS : "关联"
    
    USERS {
        string id PK
        string email
        string name
        datetime createdAt
    }
    
    TASKS {
        string id PK
        string title
        string description
        string type
        string status
        string priority
        datetime startDate
        datetime deadline
        datetime endDate
        object recurrenceRule
        string parentTaskId FK
        number progress
        datetime createdAt
        datetime updatedAt
        string syncStatus
    }
    
    JOURNALS {
        string id PK
        date date
        string title
        string content
        string mood
        array relatedTaskIds
        boolean encrypted
        datetime createdAt
        datetime updatedAt
        string syncStatus
    }
    
    TAGS {
        string id PK
        string name
        string color
        string category
    }
    
    SETTINGS {
        string key PK
        any value
        datetime updatedAt
    }
    
    SYNCLOG {
        string id PK
        string entityType
        string entityId
        string operation
        datetime timestamp
        boolean synced
    }
```

---

## 5. 数据同步流程图

```mermaid
flowchart TD
    Start([用户操作]) --> WriteLocal[写入IndexedDB]
    WriteLocal --> MarkPending[标记为待同步]
    MarkPending --> CheckNetwork{检查网络连接}
    
    CheckNetwork -->|无网络| Queue[加入同步队列]
    Queue --> Wait[等待网络恢复]
    Wait --> CheckNetwork
    
    CheckNetwork -->|有网络| CheckSync[检查同步开关]
    CheckSync -->|未开启| End1([结束])
    CheckSync -->|已开启| ReadPending[读取待同步数据]
    
    ReadPending --> BatchSync[批量同步]
    BatchSync --> CallAPI[调用后端API]
    CallAPI --> CheckConflict{检测冲突}
    
    CheckConflict -->|有冲突| ResolveConflict[冲突解决]
    ResolveConflict --> UserChoice{用户选择}
    UserChoice -->|本地版本| UseLocal[使用本地版本]
    UserChoice -->|云端版本| UseCloud[使用云端版本]
    UseLocal --> UpdateCloud[更新云端]
    UseCloud --> UpdateLocal[更新本地]
    
    CheckConflict -->|无冲突| UpdateCloud
    UpdateCloud --> UpdateStatus[更新同步状态]
    UpdateLocal --> UpdateStatus
    UpdateStatus --> End2([同步完成])
    
    style Start fill:#e1f5ff
    style WriteLocal fill:#c8e6c9
    style CheckNetwork fill:#fff9c4
    style Queue fill:#ffccbc
    style BatchSync fill:#e8f5e9
    style CheckConflict fill:#f3e5f5
    style ResolveConflict fill:#fce4ec
    style End1 fill:#e1f5ff
    style End2 fill:#e1f5ff
```

---

## 6. AI分析处理流程图

```mermaid
flowchart TD
    Start([用户输入]) --> InputType{输入类型}
    
    InputType -->|语音| VoiceInput[语音输入]
    InputType -->|文字| TextInput[文字输入]
    
    VoiceInput --> VoiceAPI{语音识别服务}
    VoiceAPI -->|Web Speech API| WebSpeech[浏览器原生识别]
    VoiceAPI -->|第三方服务| ThirdParty[第三方API识别]
    WebSpeech --> TextResult[文本结果]
    ThirdParty --> TextResult
    TextInput --> TextResult
    
    TextResult --> Preprocess[文本预处理<br/>清理、分词]
    Preprocess --> AIService[AI服务分析]
    
    AIService --> ExtractTime[提取时间信息]
    AIService --> ExtractType[提取任务类型]
    AIService --> ExtractTags[提取标签]
    AIService --> ExtractPriority[提取优先级]
    
    ExtractTime --> ParseTime[解析时间<br/>相对时间→具体日期]
    ParseTime --> TimeResult[时间结果]
    
    ExtractType --> TypeResult[任务类型结果]
    ExtractTags --> TagsResult[标签结果]
    ExtractPriority --> PriorityResult[优先级结果]
    
    TimeResult --> StructData[生成结构化数据]
    TypeResult --> StructData
    TagsResult --> StructData
    PriorityResult --> StructData
    
    StructData --> UserConfirm[用户确认/修改]
    UserConfirm --> Confirm{用户确认?}
    
    Confirm -->|是| CreateTask[创建任务]
    Confirm -->|否| EditData[编辑数据]
    EditData --> UserConfirm
    
    CreateTask --> End([任务创建完成])
    
    style Start fill:#e1f5ff
    style VoiceInput fill:#f8bbd0
    style TextInput fill:#f8bbd0
    style AIService fill:#e8f5e9
    style StructData fill:#fff9c4
    style UserConfirm fill:#c8e6c9
    style CreateTask fill:#c8e6c9
    style End fill:#e1f5ff
```

---

## 7. 重复任务生成流程图

```mermaid
flowchart TD
    Start([创建重复任务]) --> InputRule[输入重复规则]
    InputRule --> RuleType{规则类型}
    
    RuleType -->|按次数| CountRule[设置重复次数]
    RuleType -->|按时间段| DateRangeRule[设置开始/结束日期]
    RuleType -->|按间隔| IntervalRule[设置时间间隔]
    
    CountRule --> SaveRule[保存规则到数据库]
    DateRangeRule --> SaveRule
    IntervalRule --> SaveRule
    
    SaveRule --> ViewRequest{视图请求}
    
    ViewRequest -->|日历视图| CalendarView[日历视图]
    ViewRequest -->|列表视图| ListView[列表视图]
    
    CalendarView --> GetDateRange[获取视图日期范围]
    ListView --> GetDateRange
    
    GetDateRange --> CalculateInstances[计算任务实例<br/>按需生成]
    CalculateInstances --> CheckCache{检查缓存}
    
    CheckCache -->|缓存命中| UseCache[使用缓存结果]
    CheckCache -->|缓存未命中| GenerateInstances[生成实例]
    
    GenerateInstances --> ApplyRule[应用重复规则]
    ApplyRule --> FilterExclude[过滤排除日期]
    FilterExclude --> CacheResult[缓存结果]
    CacheResult --> UseCache
    
    UseCache --> DisplayTasks[显示任务]
    DisplayTasks --> End([显示完成])
    
    style Start fill:#e1f5ff
    style SaveRule fill:#c8e6c9
    style CalculateInstances fill:#fff9c4
    style CheckCache fill:#f3e5f5
    style GenerateInstances fill:#e8f5e9
    style DisplayTasks fill:#c8e6c9
    style End fill:#e1f5ff
```

---

## 8. 日历视图渲染流程图

```mermaid
flowchart TD
    Start([进入日历视图]) --> ViewType{选择视图类型}
    
    ViewType -->|月视图| MonthView[月视图]
    ViewType -->|周视图| WeekView[周视图]
    ViewType -->|日视图| DayView[日视图]
    
    MonthView --> GetMonthRange[获取月份日期范围]
    WeekView --> GetWeekRange[获取周日期范围]
    DayView --> GetDayRange[获取单日范围]
    
    GetMonthRange --> LoadTasks[加载任务数据]
    GetWeekRange --> LoadTasks
    GetDayRange --> LoadTasks
    
    LoadTasks --> FilterTasks[筛选任务<br/>按日期范围]
    FilterTasks --> ProcessRecurring[处理重复任务<br/>生成实例]
    
    ProcessRecurring --> GroupTasks[按日期分组任务]
    GroupTasks --> RenderCalendar[渲染日历网格]
    
    RenderCalendar --> MonthRender{视图类型}
    MonthRender -->|月视图| RenderMonth[渲染月视图<br/>网格布局]
    MonthRender -->|周视图| RenderWeek[渲染周视图<br/>时间轴布局]
    MonthRender -->|日视图| RenderDay[渲染日视图<br/>详细时间轴]
    
    RenderMonth --> Virtualize{任务过多?}
    Virtualize -->|是| Aggregate[聚合显示<br/>显示"更多"]
    Virtualize -->|否| ShowAll[显示所有任务]
    
    RenderWeek --> VirtualScroll[虚拟滚动<br/>只渲染可见区域]
    RenderDay --> VirtualScroll
    
    Aggregate --> End1([渲染完成])
    ShowAll --> End1
    VirtualScroll --> End1
    
    End1 --> UserInteraction{用户交互}
    UserInteraction -->|点击日期| CreateTask[创建任务]
    UserInteraction -->|拖拽任务| DragTask[拖拽任务]
    UserInteraction -->|点击任务| ViewTask[查看任务详情]
    
    CreateTask --> UpdateCalendar[更新日历]
    DragTask --> UpdateCalendar
    ViewTask --> UpdateCalendar
    UpdateCalendar --> End1
    
    style Start fill:#e1f5ff
    style LoadTasks fill:#c8e6c9
    style ProcessRecurring fill:#fff9c4
    style RenderCalendar fill:#f3e5f5
    style VirtualScroll fill:#e8f5e9
    style End1 fill:#e1f5ff
```

---

## 9. 前端项目结构树状图

```mermaid
graph TD
    Root[src/] --> Components[components/]
    Root --> Pages[pages/]
    Root --> Stores[stores/]
    Root --> Services[services/]
    Root --> Utils[utils/]
    Root --> Hooks[hooks/]
    Root --> Types[types/]
    Root --> DB[db/]
    Root --> API[api/]
    Root --> App[App.tsx]
    
    Components --> Common[common/<br/>基础组件]
    Components --> Calendar[calendar/<br/>日历组件]
    Components --> Task[task/<br/>任务组件]
    Components --> Journal[journal/<br/>日记组件]
    Components --> Voice[voice/<br/>语音组件]
    
    Pages --> TaskList[TaskList/<br/>任务列表页]
    Pages --> CalendarPage[Calendar/<br/>日历页]
    Pages --> JournalPage[Journal/<br/>日记页]
    Pages --> Settings[Settings/<br/>设置页]
    
    Stores --> TaskStore[taskStore.ts]
    Stores --> JournalStore[journalStore.ts]
    Stores --> SettingsStore[settingsStore.ts]
    Stores --> UIStore[uiStore.ts]
    
    Services --> TaskService[taskService.ts]
    Services --> JournalService[journalService.ts]
    Services --> SyncService[syncService.ts]
    Services --> AIService[aiService.ts]
    
    Utils --> DateUtils[dateUtils.ts]
    Utils --> RecurrenceUtils[recurrenceUtils.ts]
    Utils --> Encryption[encryption.ts]
    Utils --> Validators[validators.ts]
    
    Hooks --> UseTasks[useTasks.ts]
    Hooks --> UseCalendar[useCalendar.ts]
    Hooks --> UseVoice[useVoice.ts]
    
    Types --> TaskType[task.ts]
    Types --> JournalType[journal.ts]
    
    DB --> Database[database.ts<br/>Dexie实例]
    DB --> TaskRepo[taskRepository.ts]
    DB --> JournalRepo[journalRepository.ts]
    
    API --> Client[client.ts<br/>API客户端]
    API --> TaskAPI[taskApi.ts]
    API --> SyncAPI[syncApi.ts]
    
    style Root fill:#e1f5ff
    style Components fill:#fff4e6
    style Pages fill:#f3e5f5
    style Stores fill:#e8f5e9
    style Services fill:#fff9c4
    style DB fill:#c8e6c9
    style API fill:#ffccbc
```

---

## 10. 系统部署架构图

```mermaid
graph TB
    subgraph "开发环境"
        Dev[开发者]
        Git[Git仓库<br/>GitHub/GitLab]
        CI[CI/CD<br/>GitHub Actions]
    end
    
    subgraph "构建阶段"
        Build[构建流程<br/>Vite Build]
        Test[测试<br/>Vitest]
        Lint[代码检查<br/>ESLint]
    end
    
    subgraph "前端部署"
        CDN[CDN<br/>静态资源加速]
        Vercel[Vercel<br/>前端托管]
        Netlify[Netlify<br/>备选方案]
    end
    
    subgraph "后端部署 (可选)"
        Backend[后端服务<br/>Node.js/Python]
        Railway[Railway<br/>后端托管]
        Render[Render<br/>备选方案]
    end
    
    subgraph "数据库服务"
        Supabase[Supabase<br/>PostgreSQL]
        PlanetScale[PlanetScale<br/>MySQL]
    end
    
    subgraph "外部服务"
        VoiceService[语音识别服务]
        AIService[AI服务<br/>OpenAI/Claude]
    end
    
    Dev --> Git
    Git --> CI
    CI --> Build
    CI --> Test
    CI --> Lint
    Build --> Vercel
    Build --> Netlify
    Vercel --> CDN
    Netlify --> CDN
    
    Vercel -.API调用.-> Backend
    Netlify -.API调用.-> Backend
    Backend --> Railway
    Backend --> Render
    Railway --> Supabase
    Render --> PlanetScale
    
    Vercel -.调用.-> VoiceService
    Vercel -.调用.-> AIService
    Netlify -.调用.-> VoiceService
    Netlify -.调用.-> AIService
    
    style Dev fill:#e1f5ff
    style Git fill:#c8e6c9
    style CI fill:#fff9c4
    style Vercel fill:#ffccbc
    style Backend fill:#f3e5f5
    style Supabase fill:#e8f5e9
    style VoiceService fill:#f8bbd0
    style AIService fill:#f8bbd0
```

---

## 11. 用户操作流程图

```mermaid
flowchart TD
    Start([用户打开应用]) --> CheckAuth{是否已登录?}
    
    CheckAuth -->|否| Login[登录/注册]
    CheckAuth -->|是| MainView[主视图]
    
    Login --> MainView
    MainView --> ChooseAction{选择操作}
    
    ChooseAction -->|创建任务| CreateTaskFlow[创建任务流程]
    ChooseAction -->|查看日历| CalendarFlow[日历视图流程]
    ChooseAction -->|写日记| JournalFlow[日记流程]
    ChooseAction -->|语音输入| VoiceFlow[语音输入流程]
    
    CreateTaskFlow --> InputMethod{输入方式}
    InputMethod -->|手动输入| ManualInput[手动填写表单]
    InputMethod -->|语音输入| VoiceToTask[语音转任务]
    InputMethod -->|AI分析| AIToTask[AI分析输入]
    
    ManualInput --> SaveTask[保存任务]
    VoiceToTask --> AIToTask
    AIToTask --> ConfirmTask[确认任务信息]
    ConfirmTask --> SaveTask
    SaveTask --> ShowSuccess[显示成功提示]
    
    CalendarFlow --> ViewCalendar[显示日历]
    ViewCalendar --> CalendarAction{日历操作}
    CalendarAction -->|点击日期| QuickCreate[快速创建任务]
    CalendarAction -->|拖拽任务| DragTask[调整任务时间]
    CalendarAction -->|查看任务| ViewTaskDetail[查看任务详情]
    
    JournalFlow --> SelectDate[选择日期]
    SelectDate --> LoadTasks[加载当日已完成任务]
    LoadTasks --> WriteJournal[编写日记]
    WriteJournal --> SaveJournal[保存日记]
    
    VoiceFlow --> StartRecording[开始录音]
    StartRecording --> Recording[录音中...]
    Recording --> StopRecording[停止录音]
    StopRecording --> ProcessVoice[处理语音]
    ProcessVoice --> ShowText[显示识别文本]
    ShowText --> EditText[编辑文本]
    EditText --> UseText{使用文本}
    UseText -->|创建任务| AIToTask
    UseText -->|写日记| WriteJournal
    
    ShowSuccess --> MainView
    QuickCreate --> MainView
    DragTask --> MainView
    ViewTaskDetail --> MainView
    SaveJournal --> MainView
    
    style Start fill:#e1f5ff
    style MainView fill:#c8e6c9
    style CreateTaskFlow fill:#fff9c4
    style CalendarFlow fill:#f3e5f5
    style JournalFlow fill:#fce4ec
    style VoiceFlow fill:#f8bbd0
```

---

## 12. 技术栈依赖关系图

```mermaid
graph LR
    subgraph "核心框架"
        React[React 18+]
        Vite[Vite 5+]
        TS[TypeScript]
    end
    
    subgraph "状态管理"
        Zustand[Zustand]
    end
    
    subgraph "路由"
        Router[React Router v6]
    end
    
    subgraph "UI组件"
        AntD[Ant Design]
        AntDMobile[Ant Design Mobile]
    end
    
    subgraph "数据存储"
        Dexie[Dexie.js]
        IDB[IndexedDB]
    end
    
    subgraph "工具库"
        DateFns[date-fns]
        DndKit[@dnd-kit/core]
        Quill[Quill]
        Markdown[react-markdown]
        Recharts[Recharts]
    end
    
    subgraph "后端 (可选)"
        Express[Express/FastAPI]
        Prisma[Prisma/TypeORM]
        JWT[JWT]
    end
    
    subgraph "外部服务"
        WebSpeech[Web Speech API]
        OpenAI[OpenAI API]
    end
    
    React --> Zustand
    React --> Router
    React --> AntD
    React --> AntDMobile
    React --> DndKit
    React --> Quill
    React --> Markdown
    React --> Recharts
    
    Vite --> React
    Vite --> TS
    
    Dexie --> IDB
    
    Express --> Prisma
    Express --> JWT
    
    style React fill:#61dafb
    style Vite fill:#646cff
    style TS fill:#3178c6
    style Zustand fill:#443e49
    style Dexie fill:#ffd54f
    style Express fill:#000000
```

---

## 说明

以上流程图涵盖了系统的核心架构和关键流程：

1. **整体系统架构图** - 展示系统的整体结构和技术栈
2. **数据流架构图** - 展示数据的读写和同步流程
3. **前端架构分层图** - 展示前端的分层架构
4. **数据存储架构图** - 展示数据库设计和关系
5. **数据同步流程图** - 展示本地和云端数据同步机制
6. **AI分析处理流程图** - 展示AI分析任务的完整流程
7. **重复任务生成流程图** - 展示重复任务的计算和生成逻辑
8. **日历视图渲染流程图** - 展示日历视图的渲染和交互流程
9. **前端项目结构树状图** - 展示前端代码组织结构
10. **系统部署架构图** - 展示系统的部署方案
11. **用户操作流程图** - 展示主要用户操作流程
12. **技术栈依赖关系图** - 展示技术栈之间的依赖关系

这些流程图可以帮助开发团队：
- 快速理解系统整体架构
- 明确各模块之间的交互关系
- 指导开发实现
- 便于技术评审和讨论

---

## 使用说明

本文档使用 Mermaid 语法绘制流程图，可以在支持 Mermaid 的 Markdown 编辑器中直接查看，如：
- GitHub
- GitLab
- VS Code (安装 Mermaid 插件)
- 在线工具：https://mermaid.live/

如果您的编辑器不支持 Mermaid，可以将代码复制到上述工具中查看渲染效果。

